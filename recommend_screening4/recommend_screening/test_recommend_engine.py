#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Test file cho ModernRecommendationEngine
H∆∞·ªõng d·∫´n test t·ª´ng component
"""

import sys
import os
from core.recommen_engine import ModernRecommendationEngine
from models.cv_data import CVData, Project, WorkExperience
from models.job_data import JobData
from models.recommendation import RecommendationResult
from config import Config
# Add project root to path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def test_imports():
    """Test 1: Ki·ªÉm tra c√°c imports"""
    print("üß™ Test 1: Ki·ªÉm tra imports...")
    
    try:
        from core.recommen_engine import ModernRecommendationEngine
        from models.cv_data import CVData, Project, WorkExperience
        from models.job_data import JobData
        from models.recommendation import RecommendationResult
        from config import Config
        print("‚úÖ All imports successful!")
        return True
    except ImportError as e:
        print(f"‚ùå Import error: {e}")
        return False

def test_config():
    """Test 2: Ki·ªÉm tra Config"""
    print("\nüß™ Test 2: Ki·ªÉm tra Config...")
    
    try:
        # Config is a class with class attributes, not instance
        print(f"‚úÖ GOOGLE_API_KEY: {'***' if Config.GOOGLE_API_KEY else 'Not set'}")
        print(f"‚úÖ LLM_MODEL: {Config.LLM_MODEL}")
        print(f"‚úÖ MATCHING_WEIGHTS: {Config.MATCHING_WEIGHTS}")
        return True
    except Exception as e:
        print(f"‚ùå Config error: {e}")
        return False

def test_engine_initialization():
    """Test 3: Kh·ªüi t·∫°o engine"""
    print("\nüß™ Test 3: Kh·ªüi t·∫°o RecommendationEngine...")
    
    try:
        from core.recommen_engine import ModernRecommendationEngine
        engine = ModernRecommendationEngine()
        print("‚úÖ Engine initialized successfully!")
        print(f"‚úÖ Sentence model: {'Available' if engine.sentence_model else 'Using TF-IDF fallback'}")
        return engine
    except Exception as e:
        print(f"‚ùå Engine initialization error: {e}")
        return None

def create_sample_cv():
    """T·∫°o CV m·∫´u ƒë·ªÉ test"""
    from models.cv_data import CVData, Project, WorkExperience
    
    return CVData(
        full_name="Nguy·ªÖn VƒÉn Test",
        email="test@email.com",
        phone="0123456789",
        address="H√† N·ªôi",
        job_title="Python Developer",
        desired_position="Backend Developer",
        years_experience=3,
        current_company="Tech Company",
        technical_skills=["Python", "Django", "PostgreSQL", "React", "Docker"],
        soft_skills=["Communication", "Teamwork", "Problem Solving"],
        languages=["Python", "JavaScript"],
        tools=["VS Code", "Git", "Docker"],
        education_level="ƒê·∫°i h·ªçc",
        major="C√¥ng ngh·ªá th√¥ng tin",
        university="ƒê·∫°i h·ªçc ABC",
        graduation_year=2020,
        projects=[
            Project(
                name="E-commerce API",
                description="X√¢y d·ª±ng REST API cho h·ªá th·ªëng e-commerce b·∫±ng Django",
                technologies=["Python", "Django", "PostgreSQL", "Redis"],
                start_date="2022-01",
                end_date="2022-06"
            )
        ],
        work_experience=[
            WorkExperience(
                position="Python Developer",
                company="Tech Company",
                start_date="2021-01",
                end_date="Present",
                is_current=True,
                description="Ph√°t tri·ªÉn v√† maintain c√°c ·ª©ng d·ª•ng web b·∫±ng Python Django"
            )
        ]
    )

def create_sample_jobs():
    """T·∫°o jobs m·∫´u ƒë·ªÉ test"""
    from models.job_data import JobData
    
    return [
        JobData(
            job_id="JOB001",
            job_title="Senior Python Developer",
            company="ABC Tech",
            location="H√† N·ªôi",
            job_type="Full-time",
            job_description="C·∫ßn ng∆∞·ªùi c√≥ kinh nghi·ªám Python, Django, REST API, Database",
            required_skills=["Python", "Django", "PostgreSQL", "REST API"],
            responsibilities=["Ph√°t tri·ªÉn API", "T·ªëi ∆∞u database", "Code review"],
            min_experience=2,
            max_experience=5,
            education_requirement="ƒê·∫°i h·ªçc"
        ),
        JobData(
            job_id="JOB002", 
            job_title="Full Stack Developer",
            company="XYZ Corp",
            location="TP H·ªì Ch√≠ Minh",
            job_type="Full-time",
            job_description="C·∫ßn ng∆∞·ªùi bi·∫øt c·∫£ Frontend v√† Backend: React, Python, Node.js",
            required_skills=["React", "Node.js", "Python", "MongoDB"],
            responsibilities=["Ph√°t tri·ªÉn UI", "X√¢y d·ª±ng API", "Deploy application"],
            min_experience=1,
            max_experience=3,
            education_requirement="ƒê·∫°i h·ªçc"
        ),
        JobData(
            job_id="JOB003",
            job_title="DevOps Engineer", 
            company="Cloud Solutions",
            location="Remote",
            job_type="Full-time",
            job_description="Qu·∫£n l√Ω infrastructure, CI/CD, Docker, Kubernetes",
            required_skills=["Docker", "Kubernetes", "AWS", "Jenkins"],
            responsibilities=["Setup CI/CD", "Manage containers", "Monitor systems"],
            min_experience=3,
            max_experience=7,
            education_requirement="ƒê·∫°i h·ªçc"
        )
    ]

def test_text_embedding(engine):
    """Test 4: Text embedding"""
    print("\nüß™ Test 4: Text embedding...")
    
    try:
        test_text = "Python Django REST API development"
        embedding = engine._get_text_embedding(test_text)
        print(f"‚úÖ Embedding shape: {embedding.shape}")
        print(f"‚úÖ Embedding type: {type(embedding)}")
        return True
    except Exception as e:
        print(f"‚ùå Text embedding error: {e}")
        return False

def test_cosine_similarity(engine):
    """Test 5: Cosine similarity"""
    print("\nüß™ Test 5: Cosine similarity...")
    
    try:
        text1 = "Python Django web development"
        text2 = "Django Python web application"
        text3 = "Java Spring Boot development"
        
        emb1 = engine._get_text_embedding(text1)
        emb2 = engine._get_text_embedding(text2)
        emb3 = engine._get_text_embedding(text3)
        
        sim_same = engine._calculate_cosine_similarity(emb1, emb2)
        sim_diff = engine._calculate_cosine_similarity(emb1, emb3)
        
        print(f"‚úÖ Similarity (same): {sim_same:.3f}")
        print(f"‚úÖ Similarity (different): {sim_diff:.3f}")
        
        assert sim_same > sim_diff, "Same texts should be more similar"
        print("‚úÖ Cosine similarity test passed!")
        return True
    except Exception as e:
        print(f"‚ùå Cosine similarity error: {e}")
        return False

def test_recommendation_basic(engine):
    """Test 6: Basic recommendation"""
    print("\nüß™ Test 6: Basic recommendation...")
    
    try:
        cv_data = create_sample_cv()
        job_list = create_sample_jobs()
        
        print(f"‚úÖ CV: {cv_data.full_name} - {cv_data.job_title}")
        print(f"‚úÖ Skills: {', '.join(cv_data.technical_skills)}")
        print(f"‚úÖ Testing with {len(job_list)} jobs")
        
        recommendations = engine.generate_recommendations(
            cv_data=cv_data,
            job_list=job_list,
            top_k=5,
            min_score=0.1  # Gi·∫£m threshold ƒë·ªÉ d·ªÖ test
        )
        
        print(f"‚úÖ Generated {len(recommendations)} recommendations")
        
        for i, rec in enumerate(recommendations, 1):
            print(f"\nüìã Recommendation {i}:")
            print(f"   Job: {rec.job_data.job_title} at {rec.job_data.company}")
            print(f"   Score: {rec.overall_score:.3f}")
            print(f"   Skills: {rec.matching_details.skills_score:.3f}")
            print(f"   Experience: {rec.matching_details.experience_score:.3f}")
            print(f"   Location: {rec.matching_details.location_score:.3f}")
            print(f"   Matched skills: {', '.join(rec.matching_details.matched_skills)}")
            if rec.matching_details.missing_skills:
                print(f"   Missing skills: {', '.join(rec.matching_details.missing_skills)}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Basic recommendation error: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_filters(engine):
    """Test 7: Recommendation v·ªõi filters"""
    print("\nüß™ Test 7: Recommendation v·ªõi filters...")
    
    try:
        cv_data = create_sample_cv()
        job_list = create_sample_jobs()
        
        # Test location filter
        filters = {"location": "H√† N·ªôi"}
        recommendations = engine.generate_recommendations(
            cv_data=cv_data,
            job_list=job_list,
            top_k=5,
            min_score=0.1,
            filters=filters
        )
        
        print(f"‚úÖ With location filter 'H√† N·ªôi': {len(recommendations)} results")
        for rec in recommendations:
            print(f"   - {rec.job_data.job_title} in {rec.job_data.location}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Filters test error: {e}")
        return False

def test_edge_cases(engine):
    """Test 8: Edge cases"""
    print("\nüß™ Test 8: Edge cases...")
    
    try:
        from models.cv_data import CVData
        from models.job_data import JobData
        
        # Empty CV
        empty_cv = CVData(
            full_name="Empty CV",
            email="empty@test.com",
            technical_skills=[]
        )
        
        # Job v·ªõi empty skills
        empty_job = JobData(
            job_id="EMPTY001",
            job_title="Test Job",
            company="Test Company",
            location="Test Location",
            job_type="Full-time",
            job_description="Test description",
            required_skills=[],
            responsibilities=[]
        )
        
        recommendations = engine.generate_recommendations(
            cv_data=empty_cv,
            job_list=[empty_job],
            top_k=1,
            min_score=0.0
        )
        
        print(f"‚úÖ Empty CV test: {len(recommendations)} recommendations")
        if recommendations:
            print(f"   Score: {recommendations[0].overall_score:.3f}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Edge cases error: {e}")
        return False

def run_all_tests():
    """Ch·∫°y t·∫•t c·∫£ tests"""
    print("üöÄ Starting ModernRecommendationEngine Tests...\n")
    
    tests_passed = 0
    total_tests = 8
    
    # Test 1: Imports
    if test_imports():
        tests_passed += 1
    
    # Test 2: Config  
    if test_config():
        tests_passed += 1
    
    # Test 3: Engine initialization
    engine = test_engine_initialization()
    if engine:
        tests_passed += 1
        
        # Test 4: Text embedding
        if test_text_embedding(engine):
            tests_passed += 1
        
        # Test 5: Cosine similarity
        if test_cosine_similarity(engine):
            tests_passed += 1
        
        # Test 6: Basic recommendation
        if test_recommendation_basic(engine):
            tests_passed += 1
        
        # Test 7: Filters
        if test_filters(engine):
            tests_passed += 1
        
        # Test 8: Edge cases
        if test_edge_cases(engine):
            tests_passed += 1
    
    # Summary
    print(f"\n{'='*50}")
    print(f"üìä TEST RESULTS: {tests_passed}/{total_tests} passed")
    
    if tests_passed == total_tests:
        print("üéâ All tests passed! Engine is working correctly.")
    else:
        print(f"‚ö†Ô∏è  {total_tests - tests_passed} tests failed. Check logs above.")
    
    return tests_passed == total_tests

if __name__ == "__main__":
    run_all_tests() 